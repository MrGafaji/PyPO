\hypertarget{RayTrace_8h_source}{}\doxysection{Ray\+Trace.\+h}
\label{RayTrace_8h_source}\index{src/CPU/RayTrace.h@{src/CPU/RayTrace.h}}
\mbox{\hyperlink{RayTrace_8h}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{1 \textcolor{preprocessor}{\#include <iostream>}}
\DoxyCodeLine{2 \textcolor{preprocessor}{\#include <vector>}}
\DoxyCodeLine{3 \textcolor{preprocessor}{\#include <array>}}
\DoxyCodeLine{4 \textcolor{preprocessor}{\#include <cmath>}}
\DoxyCodeLine{5 \textcolor{preprocessor}{\#include <thread>}}
\DoxyCodeLine{6 }
\DoxyCodeLine{7 \textcolor{preprocessor}{\#include "{}\mbox{\hyperlink{Utils_8h}{Utils.h}}"{}}}
\DoxyCodeLine{8 \textcolor{preprocessor}{\#include "{}\mbox{\hyperlink{Structs_8h}{Structs.h}}"{}}}
\DoxyCodeLine{9 \textcolor{preprocessor}{\#include "{}\mbox{\hyperlink{RTRefls_8h}{RTRefls.h}}"{}}}
\DoxyCodeLine{10 }
\DoxyCodeLine{11 \textcolor{preprocessor}{\#define \_USE\_MATH\_DEFINES}}
\DoxyCodeLine{12 }
\DoxyCodeLine{13 \textcolor{preprocessor}{\#ifndef \_\_RayTracer\_h}}
\DoxyCodeLine{14 \textcolor{preprocessor}{\#define \_\_RayTracer\_h}}
\DoxyCodeLine{15 }
\DoxyCodeLine{16 \textcolor{keyword}{template}<\textcolor{keyword}{class} T, \textcolor{keyword}{class} U, \textcolor{keyword}{class} V>}
\DoxyCodeLine{17 \textcolor{keyword}{class }\mbox{\hyperlink{classRayTracer}{RayTracer}}}
\DoxyCodeLine{18 \{}
\DoxyCodeLine{19     \textcolor{keywordtype}{int} numThreads;}
\DoxyCodeLine{20     \textcolor{keywordtype}{int} step;}
\DoxyCodeLine{21     \textcolor{keywordtype}{int} nTot;}
\DoxyCodeLine{22 }
\DoxyCodeLine{23     V epsilon;}
\DoxyCodeLine{24 }
\DoxyCodeLine{25 \textcolor{keyword}{public}:}
\DoxyCodeLine{26     \mbox{\hyperlink{classUtils}{Utils<V>}} \mbox{\hyperlink{classRayTracer_a2f9aaccce6775a7b69c02700c6077805}{ut}};}
\DoxyCodeLine{27     std::vector<std::thread> \mbox{\hyperlink{classRayTracer_a20d7d1fcca98cb681c8436a024b2092b}{threadPool}};}
\DoxyCodeLine{28 }
\DoxyCodeLine{29     \mbox{\hyperlink{classRayTracer}{RayTracer}}(\textcolor{keywordtype}{int} numThreads, \textcolor{keywordtype}{int} nTot, V epsilon, \textcolor{keywordtype}{bool} verbose = \textcolor{keyword}{false});}
\DoxyCodeLine{30 }
\DoxyCodeLine{31     \textcolor{keywordtype}{void} \mbox{\hyperlink{classRayTracer_a54308039ddbee81e5c2d2cb0cc7f992f}{transfRays}}(T ctp, U *fr, \textcolor{keywordtype}{bool} inv = \textcolor{keyword}{false});}
\DoxyCodeLine{32 }
\DoxyCodeLine{33     \textcolor{keywordtype}{void} \mbox{\hyperlink{classRayTracer_a6ddfa49541d8ade725ce2dab3dad9e5e}{propagateRaysToP}}(\textcolor{keywordtype}{int} start, \textcolor{keywordtype}{int} stop,}
\DoxyCodeLine{34                       T ctp, U *fr\_in, U *fr\_out, V t0);}
\DoxyCodeLine{35     \textcolor{keywordtype}{void} \mbox{\hyperlink{classRayTracer_a1a45997e63a0c8fc6c89b8bc2ee2f910}{propagateRaysToH}}(\textcolor{keywordtype}{int} start, \textcolor{keywordtype}{int} stop,}
\DoxyCodeLine{36                       T ctp, U *fr\_in, U *fr\_out, V t0);}
\DoxyCodeLine{37     \textcolor{keywordtype}{void} \mbox{\hyperlink{classRayTracer_a9783a3d259b040aa3b6a2d975e7c978f}{propagateRaysToE}}(\textcolor{keywordtype}{int} start, \textcolor{keywordtype}{int} stop,}
\DoxyCodeLine{38                       T ctp, U *fr\_in, U *fr\_out, V t0);}
\DoxyCodeLine{39     \textcolor{keywordtype}{void} \mbox{\hyperlink{classRayTracer_acc4e49f68bb791d3658c2ca1a3844b01}{propagateRaysToPl}}(\textcolor{keywordtype}{int} start, \textcolor{keywordtype}{int} stop,}
\DoxyCodeLine{40                       T ctp, U *fr\_in, U *fr\_out, V t0);}
\DoxyCodeLine{41 }
\DoxyCodeLine{42     \textcolor{keywordtype}{void} \mbox{\hyperlink{classRayTracer_a5210ca2a5e832bf732529c2b2f7c6da5}{parallelRays}}(T ctp, U *fr\_in, U *fr\_out, V t0);}
\DoxyCodeLine{43 }
\DoxyCodeLine{44     \textcolor{keywordtype}{void} \mbox{\hyperlink{classRayTracer_a04fea6a2fba981f6d4a1b9a00a5e4bb5}{joinThreads}}();}
\DoxyCodeLine{45 \};}
\DoxyCodeLine{46 }
\DoxyCodeLine{47 \textcolor{keyword}{template}<\textcolor{keyword}{class} T, \textcolor{keyword}{class} U, \textcolor{keyword}{class} V>}
\DoxyCodeLine{48 \mbox{\hyperlink{classRayTracer_a8637057563c675eac417c202277a8b27}{RayTracer<T, U, V>::RayTracer}}(\textcolor{keywordtype}{int} numThreads, \textcolor{keywordtype}{int} \mbox{\hyperlink{KernelsRTf_8cu_a01cc92fb289b3db0f5ecb2afd9dd896a}{nTot}}, V epsilon, \textcolor{keywordtype}{bool} verbose)}
\DoxyCodeLine{49 \{}
\DoxyCodeLine{50     this-\/>numThreads = numThreads;}
\DoxyCodeLine{51     this-\/>step = ceil(\mbox{\hyperlink{KernelsRTf_8cu_a01cc92fb289b3db0f5ecb2afd9dd896a}{nTot}} / numThreads);}
\DoxyCodeLine{52     this-\/>nTot = \mbox{\hyperlink{KernelsRTf_8cu_a01cc92fb289b3db0f5ecb2afd9dd896a}{nTot}};}
\DoxyCodeLine{53     this-\/>threadPool.resize(numThreads);}
\DoxyCodeLine{54     this-\/>epsilon = epsilon;}
\DoxyCodeLine{55 }
\DoxyCodeLine{56     \textcolor{keywordflow}{if} (verbose)}
\DoxyCodeLine{57     \{}
\DoxyCodeLine{58         printf(\textcolor{stringliteral}{"{}<<<-\/-\/-\/-\/-\/-\/-\/-\/-\/ RT info -\/-\/-\/-\/-\/-\/-\/-\/-\/>>>\(\backslash\)n"{}});}
\DoxyCodeLine{59         printf(\textcolor{stringliteral}{"{}-\/-\/-\/ Rays          :   \%d\(\backslash\)n"{}}, \mbox{\hyperlink{KernelsRTf_8cu_a01cc92fb289b3db0f5ecb2afd9dd896a}{nTot}});}
\DoxyCodeLine{60         printf(\textcolor{stringliteral}{"{}-\/-\/-\/ Threads       :   \%d\(\backslash\)n"{}}, numThreads);}
\DoxyCodeLine{61         printf(\textcolor{stringliteral}{"{}-\/-\/-\/ Device        :   CPU\(\backslash\)n"{}});}
\DoxyCodeLine{62         printf(\textcolor{stringliteral}{"{}<<<-\/-\/-\/-\/-\/-\/-\/-\/-\/ RT info -\/-\/-\/-\/-\/-\/-\/-\/-\/>>>\(\backslash\)n"{}});}
\DoxyCodeLine{63         printf(\textcolor{stringliteral}{"{}\(\backslash\)n"{}});}
\DoxyCodeLine{64     \}}
\DoxyCodeLine{65 \}}
\DoxyCodeLine{66 }
\DoxyCodeLine{67 \textcolor{comment}{/*}}
\DoxyCodeLine{68 \textcolor{comment}{ * Transform ray-\/trace frame into target surface restframe.}}
\DoxyCodeLine{69 \textcolor{comment}{ */}}
\DoxyCodeLine{70 \textcolor{keyword}{template}<\textcolor{keyword}{class} T, \textcolor{keyword}{class} U, \textcolor{keyword}{class} V>}
\DoxyCodeLine{71 \textcolor{keywordtype}{void} \mbox{\hyperlink{classRayTracer_a54308039ddbee81e5c2d2cb0cc7f992f}{RayTracer<T, U, V>::transfRays}}(T ctp, U *fr, \textcolor{keywordtype}{bool} inv)}
\DoxyCodeLine{72 \{}
\DoxyCodeLine{73     \textcolor{keywordtype}{bool} vec = \textcolor{keyword}{true};}
\DoxyCodeLine{74     std::array<V, 3> inp, out;}
\DoxyCodeLine{75     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i=0; i<fr-\/>size; i++)}
\DoxyCodeLine{76     \{}
\DoxyCodeLine{77         inp[0] = fr-\/>x[i];}
\DoxyCodeLine{78         inp[1] = fr-\/>y[i];}
\DoxyCodeLine{79         inp[2] = fr-\/>z[i];}
\DoxyCodeLine{80 }
\DoxyCodeLine{81         \textcolor{keywordflow}{if} (inv) \{ut.invmatVec4(ctp.transf, inp, out);\}}
\DoxyCodeLine{82         \textcolor{keywordflow}{else} \{ut.matVec4(ctp.transf, inp, out);\}}
\DoxyCodeLine{83 }
\DoxyCodeLine{84         fr-\/>x[i] = out[0];}
\DoxyCodeLine{85         fr-\/>y[i] = out[1];}
\DoxyCodeLine{86         fr-\/>z[i] = out[2];}
\DoxyCodeLine{87 }
\DoxyCodeLine{88         inp[0] = fr-\/>dx[i];}
\DoxyCodeLine{89         inp[1] = fr-\/>dy[i];}
\DoxyCodeLine{90         inp[2] = fr-\/>dz[i];}
\DoxyCodeLine{91 }
\DoxyCodeLine{92         \textcolor{keywordflow}{if} (inv) \{ut.invmatVec4(ctp.transf, inp, out, vec);\}}
\DoxyCodeLine{93         \textcolor{keywordflow}{else} \{ut.matVec4(ctp.transf, inp, out, vec);\}}
\DoxyCodeLine{94 }
\DoxyCodeLine{95         fr-\/>dx[i] = out[0];}
\DoxyCodeLine{96         fr-\/>dy[i] = out[1];}
\DoxyCodeLine{97         fr-\/>dz[i] = out[2];}
\DoxyCodeLine{98     \}}
\DoxyCodeLine{99 \}}
\DoxyCodeLine{100 }
\DoxyCodeLine{101 \textcolor{keyword}{template}<\textcolor{keyword}{class} T, \textcolor{keyword}{class} U, \textcolor{keyword}{class} V>}
\DoxyCodeLine{102 \textcolor{keywordtype}{void} \mbox{\hyperlink{classRayTracer_a6ddfa49541d8ade725ce2dab3dad9e5e}{RayTracer<T, U, V>::propagateRaysToP}}(\textcolor{keywordtype}{int} start, \textcolor{keywordtype}{int} stop,}
\DoxyCodeLine{103                   T ctp, U *fr\_in, U *fr\_out, V t0)}
\DoxyCodeLine{104 \{}
\DoxyCodeLine{105     \mbox{\hyperlink{classRTRefls}{RTRefls<V>}} refls(ctp.coeffs[0], ctp.coeffs[1], ctp.coeffs[2]);}
\DoxyCodeLine{106 }
\DoxyCodeLine{107     \textcolor{keywordtype}{int} flip = 1;}
\DoxyCodeLine{108 }
\DoxyCodeLine{109     \textcolor{keywordflow}{if} (ctp.flip)}
\DoxyCodeLine{110     \{}
\DoxyCodeLine{111         flip = -\/1;}
\DoxyCodeLine{112     \}}
\DoxyCodeLine{113 }
\DoxyCodeLine{114     std::array<V, 3> norms;}
\DoxyCodeLine{115 }
\DoxyCodeLine{116     \textcolor{keywordtype}{int} jc = 0; \textcolor{comment}{// Counter}}
\DoxyCodeLine{117     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i=start; i<stop; i++)}
\DoxyCodeLine{118     \{}
\DoxyCodeLine{119         V \_t = t0;}
\DoxyCodeLine{120         V t1 = 1e99;}
\DoxyCodeLine{121 }
\DoxyCodeLine{122         V check = fabs(t1 -\/ \_t);}
\DoxyCodeLine{123 }
\DoxyCodeLine{124         V x = fr\_in-\/>x[i];}
\DoxyCodeLine{125         V y = fr\_in-\/>y[i];}
\DoxyCodeLine{126         V z = fr\_in-\/>z[i];}
\DoxyCodeLine{127 }
\DoxyCodeLine{128         V dx = fr\_in-\/>dx[i];}
\DoxyCodeLine{129         V dy = fr\_in-\/>dy[i];}
\DoxyCodeLine{130         V dz = fr\_in-\/>dz[i];}
\DoxyCodeLine{131         \textcolor{comment}{//printf("{}\%d\(\backslash\)n"{}, i);}}
\DoxyCodeLine{132 }
\DoxyCodeLine{133         \textcolor{keywordflow}{while} (check > epsilon)}
\DoxyCodeLine{134         \{}
\DoxyCodeLine{135             t1 = refls.\mbox{\hyperlink{classRTRefls_aa92969671a27dbc1fed7b39ce42cdba7}{gp}}(\_t, x, y, z, dx, dy, dz);}
\DoxyCodeLine{136 }
\DoxyCodeLine{137             check = fabs(t1 -\/ \_t);}
\DoxyCodeLine{138 }
\DoxyCodeLine{139             \_t = t1;}
\DoxyCodeLine{140         \}}
\DoxyCodeLine{141         fr\_out-\/>x[i] = x + \_t*dx;}
\DoxyCodeLine{142         fr\_out-\/>y[i] = y + \_t*dy;}
\DoxyCodeLine{143         fr\_out-\/>z[i] = z + \_t*dz;}
\DoxyCodeLine{144 }
\DoxyCodeLine{145         norms = refls.\mbox{\hyperlink{classRTRefls_af3a809bc5021ac4abaf9fc32888cbd2f}{np}}(fr\_out-\/>x[i], fr\_out-\/>y[i], fr\_out-\/>z[i], flip);}
\DoxyCodeLine{146         check = (dx*norms[0] + dy*norms[1] + dz*norms[2]);}
\DoxyCodeLine{147 }
\DoxyCodeLine{148         fr\_out-\/>dx[i] = dx -\/ 2*check*norms[0];}
\DoxyCodeLine{149         fr\_out-\/>dy[i] = dy -\/ 2*check*norms[1];}
\DoxyCodeLine{150         fr\_out-\/>dz[i] = dz -\/ 2*check*norms[2];}
\DoxyCodeLine{151 }
\DoxyCodeLine{152         \textcolor{keywordflow}{if}((i * 100 / this-\/>step) > jc \&\& start == 0 * this-\/>step)}
\DoxyCodeLine{153         \{}
\DoxyCodeLine{154             std::cout << jc << \textcolor{stringliteral}{"{} / 100"{}} << \textcolor{charliteral}{'\(\backslash\)r'};}
\DoxyCodeLine{155             std::cout.flush();}
\DoxyCodeLine{156             jc++;}
\DoxyCodeLine{157         \}}
\DoxyCodeLine{158 }
\DoxyCodeLine{159     \}}
\DoxyCodeLine{160 \}}
\DoxyCodeLine{161 }
\DoxyCodeLine{162 \textcolor{keyword}{template}<\textcolor{keyword}{class} T, \textcolor{keyword}{class} U, \textcolor{keyword}{class} V>}
\DoxyCodeLine{163 \textcolor{keywordtype}{void} \mbox{\hyperlink{classRayTracer_a1a45997e63a0c8fc6c89b8bc2ee2f910}{RayTracer<T, U, V>::propagateRaysToH}}(\textcolor{keywordtype}{int} start, \textcolor{keywordtype}{int} stop,}
\DoxyCodeLine{164                   T ctp, U *fr\_in, U *fr\_out, V t0)}
\DoxyCodeLine{165 \{}
\DoxyCodeLine{166     \mbox{\hyperlink{classRTRefls}{RTRefls<V>}} refls(ctp.coeffs[0], ctp.coeffs[1], ctp.coeffs[2]);}
\DoxyCodeLine{167 }
\DoxyCodeLine{168     \textcolor{keywordtype}{int} flip = 1;}
\DoxyCodeLine{169 }
\DoxyCodeLine{170     \textcolor{keywordflow}{if} (ctp.flip)}
\DoxyCodeLine{171     \{}
\DoxyCodeLine{172         flip = -\/1;}
\DoxyCodeLine{173     \}}
\DoxyCodeLine{174 }
\DoxyCodeLine{175     std::array<V, 3> norms;}
\DoxyCodeLine{176 }
\DoxyCodeLine{177     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i=start; i<stop; i++)}
\DoxyCodeLine{178     \{}
\DoxyCodeLine{179         V \_t = t0;}
\DoxyCodeLine{180         V t1 = 1e99;}
\DoxyCodeLine{181 }
\DoxyCodeLine{182         V check = fabs(t1 -\/ \_t);}
\DoxyCodeLine{183 }
\DoxyCodeLine{184         V x = fr\_in-\/>x[i];}
\DoxyCodeLine{185         V y = fr\_in-\/>y[i];}
\DoxyCodeLine{186         V z = fr\_in-\/>z[i];}
\DoxyCodeLine{187 }
\DoxyCodeLine{188         V dx = fr\_in-\/>dx[i];}
\DoxyCodeLine{189         V dy = fr\_in-\/>dy[i];}
\DoxyCodeLine{190         V dz = fr\_in-\/>dz[i];}
\DoxyCodeLine{191         \textcolor{keywordflow}{while} (check > epsilon)}
\DoxyCodeLine{192         \{}
\DoxyCodeLine{193             t1 = refls.\mbox{\hyperlink{classRTRefls_ad8faa309cf84020f9cbdc1e377b7f619}{gh}}(\_t, x, y, z, dx, dy, dz);}
\DoxyCodeLine{194 }
\DoxyCodeLine{195             check = fabs(t1 -\/ \_t);}
\DoxyCodeLine{196 }
\DoxyCodeLine{197             \_t = t1;}
\DoxyCodeLine{198         \}}
\DoxyCodeLine{199 }
\DoxyCodeLine{200         fr\_out-\/>x[i] = x + \_t*dx;}
\DoxyCodeLine{201         fr\_out-\/>y[i] = y + \_t*dy;}
\DoxyCodeLine{202         fr\_out-\/>z[i] = z + \_t*dz;}
\DoxyCodeLine{203 }
\DoxyCodeLine{204         norms = refls.\mbox{\hyperlink{classRTRefls_aad2f7720a62683d2505130cbdd7e50a1}{nh}}(fr\_out-\/>x[i], fr\_out-\/>y[i], fr\_out-\/>z[i], flip);}
\DoxyCodeLine{205         check = (dx*norms[0] + dy*norms[1] + dz*norms[2]);}
\DoxyCodeLine{206 }
\DoxyCodeLine{207         fr\_out-\/>dx[i] = dx -\/ 2*check*norms[0];}
\DoxyCodeLine{208         fr\_out-\/>dy[i] = dy -\/ 2*check*norms[1];}
\DoxyCodeLine{209         fr\_out-\/>dz[i] = dz -\/ 2*check*norms[2];}
\DoxyCodeLine{210     \}}
\DoxyCodeLine{211 \}}
\DoxyCodeLine{212 }
\DoxyCodeLine{213 \textcolor{keyword}{template}<\textcolor{keyword}{class} T, \textcolor{keyword}{class} U, \textcolor{keyword}{class} V>}
\DoxyCodeLine{214 \textcolor{keywordtype}{void} \mbox{\hyperlink{classRayTracer_a9783a3d259b040aa3b6a2d975e7c978f}{RayTracer<T, U, V>::propagateRaysToE}}(\textcolor{keywordtype}{int} start, \textcolor{keywordtype}{int} stop,}
\DoxyCodeLine{215                   T ctp, U *fr\_in, U *fr\_out, V t0)}
\DoxyCodeLine{216 \{}
\DoxyCodeLine{217     \mbox{\hyperlink{classRTRefls}{RTRefls<V>}} refls(ctp.coeffs[0], ctp.coeffs[1], ctp.coeffs[2]);}
\DoxyCodeLine{218 }
\DoxyCodeLine{219     \textcolor{keywordtype}{int} flip = 1;}
\DoxyCodeLine{220 }
\DoxyCodeLine{221     \textcolor{keywordflow}{if} (ctp.flip)}
\DoxyCodeLine{222     \{}
\DoxyCodeLine{223         flip = -\/1;}
\DoxyCodeLine{224     \}}
\DoxyCodeLine{225 }
\DoxyCodeLine{226     std::array<V, 3> norms;}
\DoxyCodeLine{227 }
\DoxyCodeLine{228     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i=start; i<stop; i++)}
\DoxyCodeLine{229     \{}
\DoxyCodeLine{230         V \_t = t0;}
\DoxyCodeLine{231         V t1 = 1e99;}
\DoxyCodeLine{232 }
\DoxyCodeLine{233         V check = fabs(t1 -\/ \_t);}
\DoxyCodeLine{234 }
\DoxyCodeLine{235         V x = fr\_in-\/>x[i];}
\DoxyCodeLine{236         V y = fr\_in-\/>y[i];}
\DoxyCodeLine{237         V z = fr\_in-\/>z[i];}
\DoxyCodeLine{238 }
\DoxyCodeLine{239         V dx = fr\_in-\/>dx[i];}
\DoxyCodeLine{240         V dy = fr\_in-\/>dy[i];}
\DoxyCodeLine{241         V dz = fr\_in-\/>dz[i];}
\DoxyCodeLine{242         \textcolor{keywordflow}{while} (check > epsilon)}
\DoxyCodeLine{243         \{}
\DoxyCodeLine{244             t1 = refls.\mbox{\hyperlink{classRTRefls_aba6423f67d87022681cd6fdc35bfbcc5}{ge}}(\_t, x, y, z, dx, dy, dz);}
\DoxyCodeLine{245 }
\DoxyCodeLine{246             check = fabs(t1 -\/ \_t);}
\DoxyCodeLine{247 }
\DoxyCodeLine{248             \_t = t1;}
\DoxyCodeLine{249         \}}
\DoxyCodeLine{250 }
\DoxyCodeLine{251         fr\_out-\/>x[i] = x + \_t*dx;}
\DoxyCodeLine{252         fr\_out-\/>y[i] = y + \_t*dy;}
\DoxyCodeLine{253         fr\_out-\/>z[i] = z + \_t*dz;}
\DoxyCodeLine{254 }
\DoxyCodeLine{255         norms = refls.\mbox{\hyperlink{classRTRefls_a66edec57e54602c6c1304a2cab5238d3}{ne}}(fr\_out-\/>x[i], fr\_out-\/>y[i], fr\_out-\/>z[i], flip);}
\DoxyCodeLine{256         check = (dx*norms[0] + dy*norms[1] + dz*norms[2]);}
\DoxyCodeLine{257 }
\DoxyCodeLine{258         fr\_out-\/>dx[i] = dx -\/ 2*check*norms[0];}
\DoxyCodeLine{259         fr\_out-\/>dy[i] = dy -\/ 2*check*norms[1];}
\DoxyCodeLine{260         fr\_out-\/>dz[i] = dz -\/ 2*check*norms[2];}
\DoxyCodeLine{261     \}}
\DoxyCodeLine{262 \}}
\DoxyCodeLine{263 }
\DoxyCodeLine{264 \textcolor{keyword}{template}<\textcolor{keyword}{class} T, \textcolor{keyword}{class} U, \textcolor{keyword}{class} V>}
\DoxyCodeLine{265 \textcolor{keywordtype}{void} \mbox{\hyperlink{classRayTracer_acc4e49f68bb791d3658c2ca1a3844b01}{RayTracer<T, U, V>::propagateRaysToPl}}(\textcolor{keywordtype}{int} start, \textcolor{keywordtype}{int} stop,}
\DoxyCodeLine{266                   T ctp, U *fr\_in, U *fr\_out, V t0)}
\DoxyCodeLine{267 \{}
\DoxyCodeLine{268     \mbox{\hyperlink{classRTRefls}{RTRefls<V>}} refls(ctp.coeffs[0], ctp.coeffs[1], ctp.coeffs[2]);}
\DoxyCodeLine{269 }
\DoxyCodeLine{270     \textcolor{keywordtype}{int} flip = 1;}
\DoxyCodeLine{271 }
\DoxyCodeLine{272     \textcolor{keywordflow}{if} (ctp.flip)}
\DoxyCodeLine{273     \{}
\DoxyCodeLine{274         flip = -\/1;}
\DoxyCodeLine{275     \}}
\DoxyCodeLine{276 }
\DoxyCodeLine{277     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i=start; i<stop; i++)}
\DoxyCodeLine{278     \{}
\DoxyCodeLine{279         V \_t = t0;}
\DoxyCodeLine{280         V t1 = 1e99;}
\DoxyCodeLine{281 }
\DoxyCodeLine{282         V check = fabs(t1 -\/ \_t);}
\DoxyCodeLine{283         std::array<V, 3> norms;}
\DoxyCodeLine{284 }
\DoxyCodeLine{285         V x = fr\_in-\/>x[i];}
\DoxyCodeLine{286         V y = fr\_in-\/>y[i];}
\DoxyCodeLine{287         V z = fr\_in-\/>z[i];}
\DoxyCodeLine{288 }
\DoxyCodeLine{289         V dx = fr\_in-\/>dx[i];}
\DoxyCodeLine{290         V dy = fr\_in-\/>dy[i];}
\DoxyCodeLine{291         V dz = fr\_in-\/>dz[i];}
\DoxyCodeLine{292         \textcolor{keywordflow}{while} (check > epsilon)}
\DoxyCodeLine{293         \{}
\DoxyCodeLine{294             t1 = refls.\mbox{\hyperlink{classRTRefls_a834d24129d68eed262c8d4db67400f10}{gpl}}(\_t, x, y, z, dx, dy, dz);}
\DoxyCodeLine{295 }
\DoxyCodeLine{296             check = fabs(t1 -\/ \_t);}
\DoxyCodeLine{297 }
\DoxyCodeLine{298             \_t = t1;}
\DoxyCodeLine{299         \}}
\DoxyCodeLine{300 }
\DoxyCodeLine{301         fr\_out-\/>x[i] = x + \_t*dx;}
\DoxyCodeLine{302         fr\_out-\/>y[i] = y + \_t*dy;}
\DoxyCodeLine{303         fr\_out-\/>z[i] = z + \_t*dz;}
\DoxyCodeLine{304 }
\DoxyCodeLine{305         norms = refls.\mbox{\hyperlink{classRTRefls_a8adb0add912ae72df0afe6fa87c3f812}{npl}}(fr\_out-\/>x[i], fr\_out-\/>y[i], fr\_out-\/>z[i], flip);}
\DoxyCodeLine{306         check = (dx*norms[0] + dy*norms[1] + dz*norms[2]);}
\DoxyCodeLine{307 }
\DoxyCodeLine{308         fr\_out-\/>dx[i] = dx -\/ 2*check*norms[0];}
\DoxyCodeLine{309         fr\_out-\/>dy[i] = dy -\/ 2*check*norms[1];}
\DoxyCodeLine{310         fr\_out-\/>dz[i] = dz -\/ 2*check*norms[2];}
\DoxyCodeLine{311     \}}
\DoxyCodeLine{312 \}}
\DoxyCodeLine{313 }
\DoxyCodeLine{314 }
\DoxyCodeLine{315 \textcolor{keyword}{template} <\textcolor{keyword}{class} T, \textcolor{keyword}{class} U, \textcolor{keyword}{class} V>}
\DoxyCodeLine{316 \textcolor{keywordtype}{void} \mbox{\hyperlink{classRayTracer_a5210ca2a5e832bf732529c2b2f7c6da5}{RayTracer<T, U, V>::parallelRays}}(T ctp, U *fr\_in, U *fr\_out, V t0)}
\DoxyCodeLine{317 \{}
\DoxyCodeLine{318     \textcolor{keywordtype}{int} final\_step;}
\DoxyCodeLine{319 }
\DoxyCodeLine{320     \textcolor{comment}{// Transform to reflector rest frame}}
\DoxyCodeLine{321     \textcolor{keywordtype}{bool} inv = \textcolor{keyword}{true};}
\DoxyCodeLine{322     \mbox{\hyperlink{KernelsRTf_8cu_a8e11820281e7691d1ebe20e66176bb53}{transfRays}}(ctp, fr\_in, inv);}
\DoxyCodeLine{323 }
\DoxyCodeLine{324     \textcolor{keywordflow}{for}(\textcolor{keywordtype}{int} n=0; n<numThreads; n++)}
\DoxyCodeLine{325     \{}
\DoxyCodeLine{326         \textcolor{keywordflow}{if}(n == (numThreads-\/1)) \{final\_step = \mbox{\hyperlink{KernelsRTf_8cu_a01cc92fb289b3db0f5ecb2afd9dd896a}{nTot}};\}}
\DoxyCodeLine{327         \textcolor{keywordflow}{else} \{final\_step = (n+1) * step;\}}
\DoxyCodeLine{328 }
\DoxyCodeLine{329         \textcolor{keywordflow}{if} (ctp.type == 0)}
\DoxyCodeLine{330         \{}
\DoxyCodeLine{331             threadPool[n] = std::thread(\&\mbox{\hyperlink{classRayTracer_a6ddfa49541d8ade725ce2dab3dad9e5e}{RayTracer::propagateRaysToP}},}
\DoxyCodeLine{332                                         \textcolor{keyword}{this}, n * step, final\_step,}
\DoxyCodeLine{333                                         ctp, fr\_in, fr\_out, t0);}
\DoxyCodeLine{334         \}}
\DoxyCodeLine{335 }
\DoxyCodeLine{336         \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (ctp.type == 1)}
\DoxyCodeLine{337         \{}
\DoxyCodeLine{338             threadPool[n] = std::thread(\&\mbox{\hyperlink{classRayTracer_a1a45997e63a0c8fc6c89b8bc2ee2f910}{RayTracer::propagateRaysToH}},}
\DoxyCodeLine{339                                         \textcolor{keyword}{this}, n * step, final\_step,}
\DoxyCodeLine{340                                         ctp, fr\_in, fr\_out, t0);}
\DoxyCodeLine{341         \}}
\DoxyCodeLine{342 }
\DoxyCodeLine{343         \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (ctp.type == 2)}
\DoxyCodeLine{344         \{}
\DoxyCodeLine{345             threadPool[n] = std::thread(\&\mbox{\hyperlink{classRayTracer_a9783a3d259b040aa3b6a2d975e7c978f}{RayTracer::propagateRaysToE}},}
\DoxyCodeLine{346                                         \textcolor{keyword}{this}, n * step, final\_step,}
\DoxyCodeLine{347                                         ctp, fr\_in, fr\_out, t0);}
\DoxyCodeLine{348         \}}
\DoxyCodeLine{349 }
\DoxyCodeLine{350         \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (ctp.type == 3)}
\DoxyCodeLine{351         \{}
\DoxyCodeLine{352             threadPool[n] = std::thread(\&\mbox{\hyperlink{classRayTracer_acc4e49f68bb791d3658c2ca1a3844b01}{RayTracer::propagateRaysToPl}},}
\DoxyCodeLine{353                                         \textcolor{keyword}{this}, n * step, final\_step,}
\DoxyCodeLine{354                                         ctp, fr\_in, fr\_out, t0);}
\DoxyCodeLine{355         \}}
\DoxyCodeLine{356     \}}
\DoxyCodeLine{357     joinThreads();}
\DoxyCodeLine{358 }
\DoxyCodeLine{359     \textcolor{comment}{// Transform back to real frame}}
\DoxyCodeLine{360     \mbox{\hyperlink{KernelsRTf_8cu_a8e11820281e7691d1ebe20e66176bb53}{transfRays}}(ctp, fr\_in);}
\DoxyCodeLine{361     \mbox{\hyperlink{KernelsRTf_8cu_a8e11820281e7691d1ebe20e66176bb53}{transfRays}}(ctp, fr\_out);}
\DoxyCodeLine{362 \}}
\DoxyCodeLine{363 }
\DoxyCodeLine{364 \textcolor{keyword}{template} <\textcolor{keyword}{class} T, \textcolor{keyword}{class} U, \textcolor{keyword}{class} V>}
\DoxyCodeLine{365 \textcolor{keywordtype}{void} \mbox{\hyperlink{classRayTracer_a04fea6a2fba981f6d4a1b9a00a5e4bb5}{RayTracer<T, U, V>::joinThreads}}()}
\DoxyCodeLine{366 \{}
\DoxyCodeLine{367     \textcolor{keywordflow}{for} (std::thread \&t : threadPool) \{\textcolor{keywordflow}{if} (t.joinable()) \{t.join();\}\}}
\DoxyCodeLine{368 \}}
\DoxyCodeLine{369 \textcolor{preprocessor}{\#endif}}

\end{DoxyCode}
